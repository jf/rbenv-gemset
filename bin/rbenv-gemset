#!/usr/bin/env bash
set -e

RBENV_GEMSET_VERSION="0.2.0"

case "$1" in
"active")
  if [ -e "/etc/rbenv.d/util/gemset.bash" ]; then
    source "/etc/rbenv.d/util/gemset.bash"
  elif [ -e "${HOME}/.rbenv/rbenv.d/util/gemset.bash" ]; then
    source "${HOME}/.rbenv/rbenv.d/util/gemset.bash"
  else
    echo "unable to find gemset plugin in /etc/rbenv.d or ${HOME}/.rbenv/rbenv.d" >&2
    exit 1
  fi

  if [ -n "$(active_gemsets)" ]; then
    for gemset in $(active_gemsets); do
      echo "${gemset}"
    done
  else
    echo "no active gemsets" >&2
  fi
  ;;

"create")
  RBENV_VERSION="$2"
  if [ -z "${RBENV_VERSION}" ]; then
    echo "you must specify an installed version to associate the gemset with" >&2
    echo "available versions are:"
    rbenv versions
    exit 1
  fi

  rbenv prefix "${RBENV_VERSION}" > /dev/null # make sure the provided version exists
    
  RBENV_GEMSET="$3"
  if [ -z "${RBENV_GEMSET}" ]; then
    echo "you must specify a name for the new gemset" >&2
    exit 1
  fi

  RBENV_GEMSET_PATH="$(rbenv prefix "${RBENV_VERSION}")/gemsets/${RBENV_GEMSET}"

  mkdir -p "${RBENV_GEMSET_PATH}"
  echo "created ${RBENV_GEMSET} for ${RBENV_VERSION}"
  ;;

"delete")
  RBENV_VERSION="$2"
  RBENV_GEMSET="$3"
  if [[ -z "${RBENV_VERSION}" || -z "${RBENV_GEMSET}" ]]; then
    echo "you must specify a version and its associated gemset" >&2
    exit 1
  fi

  rm -rf "$(rbenv prefix "${RBENV_VERSION}")/gemsets/${RBENV_GEMSET}"
  echo "deleted ${RBENV_GEMSET} from ${RBENV_VERSION}"
  ;;

"list")
  for version in $(rbenv versions --bare); do
    shopt -s nullglob
    gemsets=($(rbenv prefix $version)/gemsets/*)
    shopt -u nullglob

    if [ -n "$gemsets" ]; then
      echo "$version:"
      for gemset in ${gemsets[@]}; do
        echo "  ${gemset##*/}"
      done
    fi
  done
  ;;

"install")
  if [ "$2" == "-g" ]; then
    RBENV_PLUGIN_ROOT=/etc/rbenv.d
  elif [ -n "$DESTDIR" ]; then
    RBENV_PLUGIN_ROOT=${DESTDIR}
  else
    RBENV_PLUGIN_ROOT="${HOME}/.rbenv/rbenv.d"
  fi

  RBENV_GEMSET_SYSTEM_ROOT="/usr/local/share/ruby-gemsets"

  mkdir -p "${RBENV_PLUGIN_ROOT}/exec"
  mkdir -p "${RBENV_PLUGIN_ROOT}/rehash"
  mkdir -p "${RBENV_PLUGIN_ROOT}/util"
  mkdir -p "${RBENV_PLUGIN_ROOT}/which"

  cat > "${RBENV_PLUGIN_ROOT}/util/gemset.bash" <<-'PLUGIN'
find_gemset_file() {
  local root="$(pwd)"
  while [ -n "$root" ]; do
    if [ -e "${root}/.rbenv-gemsets" ]; then
      echo "${root}/.rbenv-gemsets"
      return 0
    fi
    root="${root%/*}"
  done
  return 1
}

active_gemsets() {
  local gemset_file="$(find_gemset_file || true)"

  if [ -n "$gemset_file" ]; then
    cat "$gemset_file"
  else
    echo
  fi

  return 0
}
PLUGIN

  cat > "${RBENV_PLUGIN_ROOT}/exec/gemset.bash" <<-PLUGIN
source "${RBENV_PLUGIN_ROOT}/util/gemset.bash"

unset GEM_HOME GEM_PATH

if [ "\$(rbenv-version-name)" = "system" ]; then
  RBENV_GEMSET_ROOT="$RBENV_GEMSET_SYSTEM_ROOT"
else
  RBENV_GEMSET_ROOT="\$(rbenv prefix)/gemsets"
fi

for gemset in \$(active_gemsets)
do
  path="\${RBENV_GEMSET_ROOT}/\${gemset}"
  if [ -z "\${GEM_HOME}" ]; then
    GEM_HOME=\$path
    GEM_PATH=\$path
  else
    GEM_PATH=\$GEM_PATH:\$path
  fi
done

if [ -n "\$GEM_HOME" ]; then
  export GEM_HOME GEM_PATH
fi
PLUGIN

  cat > "${RBENV_PLUGIN_ROOT}/which/gemset.bash" <<-PLUGIN
source "${RBENV_PLUGIN_ROOT}/util/gemset.bash"

if [ "\$(rbenv-version-name)" = "system" ]; then
  RBENV_GEMSET_ROOT="$RBENV_GEMSET_SYSTEM_ROOT"
else
  RBENV_GEMSET_ROOT="\$(rbenv prefix)/gemsets"
fi

if [ ! -x "\$RBENV_COMMAND_PATH" ]; then
  for gemset in \$(active_gemsets); do
    command="\${RBENV_GEMSET_ROOT}/\${gemset}/bin/\$RBENV_COMMAND"
    if [ -x "\$command" ]; then
      RBENV_COMMAND_PATH=\$command
      break
    fi
  done
fi
PLUGIN

  cat > "${RBENV_PLUGIN_ROOT}/rehash/gemset.bash" <<-PLUGIN
shopt -s nullglob
gemset_bin=(\${HOME}/.rbenv/versions/*/gemsets/*/bin/*)
shopt -s nullglob

make_shims \${gemset_bin[@]}
PLUGIN

  echo "rbenv-gemset plugin installed"
  ;;

"uninstall")
  if [ "$2" == "-g" ]; then
    RBENV_PLUGIN_ROOT=/etc/rbenv.d
  else
    RBENV_PLUGIN_ROOT="${HOME}/.rbenv/rbenv.d"
  fi

  rm -f "${RBENV_PLUGIN_ROOT}/exec/gemset.bash"
  rm -f "${RBENV_PLUGIN_ROOT}/rehash/gemset.bash"
  rm -f "${RBENV_PLUGIN_ROOT}/util/gemset.bash"
  rm -f "${RBENV_PLUGIN_ROOT}/which/gemset.bash"

  echo "rbenv-gemset plugin uninstalled"
  ;;

"version")
  echo "rbenv-gemset ${RBENV_GEMSET_VERSION}"
  echo "by Jamis Buck <jamis@jamisbuck.org>"
  echo "http://github.com/jamis/rbenv-gemset"
  ;;

*)
  echo "version ${RBENV_GEMSET_VERSION}" >&2
  echo "${0##*/} [command] [options]" >&2
  echo >&2
  echo "possible commands are:" >&2
  echo "  active" >&2
  echo "  create [version] [gemset]" >&2
  echo "  delete [version] [gemset]" >&2
  echo "  list" >&2
  echo "  install [-g]" >&2
  echo "  uninstall [-g]" >&2
  echo "  version" >&2
  ;;
esac
